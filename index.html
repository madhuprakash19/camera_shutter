<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live P2P Cam</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        body { font-family: sans-serif; background: #111; color: white; text-align: center; margin: 0; padding: 10px; }
        .box { max-width: 450px; margin: auto; background: #222; padding: 15px; border-radius: 15px; }
        video { width: 100%; border-radius: 10px; background: #000; margin-top: 10px; }
        #remote-preview { width: 160px; height: 120px; position: fixed; bottom: 20px; right: 20px; border: 2px solid #0f8; }
        #qrcode { background: white; padding: 10px; display: inline-block; margin: 10px; border-radius: 5px; }
        .btn { background: #00ff88; color: black; border: none; padding: 12px; width: 100%; border-radius: 8px; font-weight: bold; margin: 5px 0; }
        .shutter { width: 70px; height: 70px; background: white; border-radius: 50%; margin: 20px auto; border: 5px solid #00ff88; cursor: pointer; }
        .hidden { display: none; }
    </style>
</head>
<body>

<div class="box">
    <h3>Live Remote Cam</h3>
    <div id="status" style="color: #888; font-size: 12px;">Choose a role</div>

    <div id="setup">
        <button class="btn" onclick="startApp('camera')">ðŸ“¸ ACT AS CAMERA</button>
        <button class="btn" onclick="startApp('remote')">ðŸ“± ACT AS REMOTE</button>
    </div>

    <div id="camera-ui" class="hidden">
        <div id="qrcode"></div>
        <video id="local-video" autoplay playsinline muted style="transform: scaleX(-1);"></video>
    </div>

    <div id="remote-ui" class="hidden">
        <div id="reader"></div>
        <video id="remote-video" autoplay playsinline style="width:100%; height:200px;"></video>
        <div class="shutter" onclick="capture()"></div>
        <p>Live Preview Active</p>
    </div>
</div>

<script>
    let peer, conn, currentCall;

    function startApp(role) {
        document.getElementById('setup').classList.add('hidden');
        peer = new Peer({ config: {'iceServers': [{ 'urls': 'stun:stun.l.google.com:19302' }]} });

        peer.on('open', (id) => {
            if (role === 'camera') setupCamera(id);
            else setupRemote();
        });
    }

    // --- CAMERA PHONE ---
    async function setupCamera(id) {
        document.getElementById('camera-ui').classList.remove('hidden');
        const link = window.location.origin + window.location.pathname + "?join=" + id;
        new QRCode(document.getElementById("qrcode"), { text: link, width: 150, height: 150 });

        // Capture High-Res for photo, but we will stream it Low-Res
        const stream = await navigator.mediaDevices.getUserMedia({ 
            video: { facingMode: "environment", width: 640 } 
        });
        document.getElementById('local-video').srcObject = stream;

        // Answer incoming calls with our stream
        peer.on('call', (call) => {
            call.answer(stream);
            handleStream(call);
        });

        peer.on('connection', (c) => { 
            conn = c; 
            conn.on('data', d => d === 'SNAP' && takePhoto());
            // After connection is established, we can technically go offline
            setTimeout(() => peer.disconnect(), 5000); 
        });
    }

    // --- REMOTE PHONE ---
    function setupRemote() {
        document.getElementById('remote-ui').classList.remove('hidden');
        const scanner = new Html5Qrcode("reader");
        scanner.start({ facingMode: "environment" }, { fps: 10, qrbox: 200 }, (url) => {
            scanner.stop();
            document.getElementById('reader').classList.add('hidden');
            const targetId = new URL(url).searchParams.get('join');
            
            // Start Data connection
            conn = peer.connect(targetId);
            
            // Start Video Call (Requesting low-res to save bandwidth)
            navigator.mediaDevices.getUserMedia({ video: { width: 160, height: 120 }, audio: false })
            .then(myStream => {
                const call = peer.call(targetId, myStream);
                handleStream(call);
            });
        });
    }

    function handleStream(call) {
        call.on('stream', (remoteStream) => {
            document.getElementById('remote-video').srcObject = remoteStream;
            document.getElementById('status').innerText = "LIVE FEED CONNECTED";
        });
    }

    function capture() { conn.send('SNAP'); }

    function takePhoto() {
        const v = document.getElementById('local-video');
        const canvas = document.createElement('canvas');
        canvas.width = v.videoWidth; canvas.height = v.videoHeight;
        canvas.getContext('2d').drawImage(v, 0, 0);
        conn.send({ img: canvas.toDataURL('image/jpeg', 0.9) });
    }

    peer && peer.on('data', data => { if(data.img) download(data.img); });
    function download(url) {
        const a = document.createElement('a'); a.href = url;
        a.download = `snap_${Date.now()}.jpg`; a.click();
    }
</script>
</body>
</html>
